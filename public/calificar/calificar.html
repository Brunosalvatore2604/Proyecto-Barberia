<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calificar servicio - Beauty Club</title>
    <link rel="stylesheet" href="/calificar/calificar.css">
</head>
<body>
    <div class="calificar-box">
        <h2>¿Cómo fue tu experiencia?</h2>
        <div class="estrellas" id="estrellas">
            <span class="estrella" data-value="1">★</span>
            <span class="estrella" data-value="2">★</span>
            <span class="estrella" data-value="3">★</span>
            <span class="estrella" data-value="4">★</span>
            <span class="estrella" data-value="5">★</span>
        </div>
        <textarea id="comentario" placeholder="¿Algún comentario? (opcional)" maxlength="255" style="width:100%;margin:12px 0 8px 0;min-height:60px;resize:vertical;"></textarea>
        <button class="btn" id="btn-enviar">Enviar calificación</button>
        <div class="msg" id="msg"></div>
    </div>
    <script>
    // Obtener token de la URL
    const token = window.location.pathname.split('/').pop();
    let puntuacion = 0;
    const estrellas = document.querySelectorAll('.estrella');
    estrellas.forEach(e => {
        e.addEventListener('mouseenter', function() {
            estrellas.forEach(st => st.classList.remove('selected'));
            for (let i = 0; i < +this.dataset.value; i++) estrellas[i].classList.add('selected');
        });
        e.addEventListener('mouseleave', function() {
            estrellas.forEach(st => st.classList.remove('selected'));
            if (puntuacion > 0) for (let i = 0; i < puntuacion; i++) estrellas[i].classList.add('selected');
        });
        e.addEventListener('click', function() {
            puntuacion = +this.dataset.value;
            estrellas.forEach(st => st.classList.remove('selected'));
            for (let i = 0; i < puntuacion; i++) estrellas[i].classList.add('selected');
        });
    });
    document.getElementById('btn-enviar').onclick = async function() {
        if (puntuacion < 1 || puntuacion > 5) {
            document.getElementById('msg').textContent = 'Selecciona una puntuación.';
            return;
        }
        this.disabled = true;
        document.getElementById('msg').textContent = 'Enviando...';
        const comentario = document.getElementById('comentario').value.trim();
        const res = await fetch(`/api/calificar/${token}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ puntuacion, comentario })
        });
        const data = await res.json();
        if (data.ok) {
            document.getElementById('msg').textContent = '¡Gracias por tu calificación!';
            document.querySelector('.estrellas').style.pointerEvents = 'none';
        } else {
            document.getElementById('msg').textContent = data.mensaje || 'Error al guardar la calificación.';
            this.disabled = false;
        }
    };
    </script>
</body>
</html>
